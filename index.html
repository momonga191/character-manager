<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç›—è³Šã®çœ¼ | Bilingual Output Edition (Viewport Fit)</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --panel:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --radius:16px;
      --shadow: 0 10px 30px rgba(17,24,39,.08);
      --shadow2: 0 6px 18px rgba(17,24,39,.06);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Sans", "Yu Gothic", "Meiryo", Arial, sans-serif;
    }
    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 800px at 10% 0%, #eef2ff 0%, rgba(238,242,255,0) 60%),
        radial-gradient(900px 600px at 100% 15%, #ecfeff 0%, rgba(236,254,255,0) 55%),
        var(--bg);
      color:var(--ink);
      font-family:var(--sans);
      line-height:1.45;
      overflow:hidden; /* ãƒšãƒ¼ã‚¸å…¨ä½“ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯æŠ‘ãˆã‚‹ */
    }

    .wrap{
      height:100%;
      max-width: 1240px;
      margin: 0 auto;
      padding: 12px 12px 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      min-height:0;
    }

    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      padding: 4px 6px;
      flex: 0 0 auto;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    h1{
      margin:0;
      font-size: 15px;
      letter-spacing:.02em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sub{
      margin:0;
      color:var(--muted);
      font-size: 11.5px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.7);
      border-radius:999px;
      box-shadow: var(--shadow2);
      color:var(--muted);
      font-size:11.5px;
      white-space:nowrap;
      flex: 0 0 auto;
    }

    /* One form wraps both columns so output always updates */
    form#cwForm{
      flex: 1 1 auto;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    @media (max-width: 980px){
      body{ overflow:auto; } /* å°ç”»é¢ã¯ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¨±å¯ */
      form#cwForm{ grid-template-columns: 1fr; }
      header{ flex-direction:column; align-items:flex-start; }
    }

    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .card .head{
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      flex-wrap: wrap;
      flex: 0 0 auto;
    }
    .card .head h2{
      margin:0;
      font-size: 13px;
      letter-spacing:.01em;
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .card .head .hint{
      color:var(--muted);
      font-size:11.5px;
      white-space:nowrap;
    }
    .card .body{
      padding: 10px 12px 12px;
      flex: 1 1 auto;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    /* Compact selects: grid instead of wide flex */
    .selectGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(140px, 1fr));
      gap: 8px;
      align-items:end;
    }
    @media (max-width: 1180px){
      .selectGrid{ grid-template-columns: repeat(2, minmax(140px, 1fr)); }
    }
    label.select{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:11.5px;
      color:var(--muted);
      min-width:0;
    }
    select{
      appearance:none;
      -webkit-appearance:none;
      -moz-appearance:none;
      border:1px solid var(--line);
      background: #fff;
      border-radius: 12px;
      padding: 8px 32px 8px 10px;
      font-size: 12.5px;
      color: var(--ink);
      outline:none;
      box-shadow: 0 2px 0 rgba(17,24,39,.03);
      min-width:0;
    }
    .selectWrap{
      position:relative;
      display:inline-block;
      width:100%;
    }
    .selectWrap::after{ display:none; }

    /* Traits area becomes internally scrollable to keep page non-scrolling */
    .traitsHeader{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      margin-top: 2px;
    }
    .traitsHeader .tTitle{
      font-size:12.5px;
      font-weight:700;
    }
    
    .traitsViewport{
      flex: 1 1 auto;
      min-height:0;
      overflow:auto;
      padding-right: 6px; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼åˆ† */
    }
    .traitsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 10px;
      min-height:0;
    }
    @media (max-width: 980px){
      .traitsViewport{ overflow:visible; padding-right:0; }
      .traitsGrid{ grid-template-columns: 1fr; }
    }

    .traitRow{
      border:1px solid var(--line);
      border-radius: 12px;
      padding: 7px 8px;
      background: linear-gradient(180deg, #ffffff 0%, #fbfbff 100%);
      box-shadow: 0 2px 0 rgba(17,24,39,.02);
      min-width:0;
    }
    .pillRow{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 6px;
      width: 100%;
    }
        @media (max-width: 980px){
      .traitsViewport{ overflow:visible; padding-right:0; }
      .traitsGrid{ grid-template-columns: 1fr; }
    }

    .pill{
      position:relative;
      border-radius: 999px;
      border:1px solid var(--line);
      background: #fff;
      padding: 6px 6px;
      text-align:center;
      font-size: 11.8px;
      color: var(--ink);
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      transition: transform .05s ease, border-color .15s ease, background .15s ease, box-shadow .15s ease;
    }
    .pill:hover{
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(17,24,39,.06);
      border-color: #d1d5db;
    }
    .pill input{
      position:absolute;
      opacity:0;
      pointer-events:none;
    }
    .pill.is-on{
      border-color: #c7d2fe;
      background: #eef2ff;
      box-shadow: 0 10px 22px rgba(99,102,241,.10);
    }

    /* Output */
    .actions{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      position: relative;
      margin-left: auto;
      flex: 0 0 auto;
      flex-wrap: nowrap;
      white-space: nowrap;
    }
    button{
      border:1px solid var(--line);
      background: #fff;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 12px;
      color: var(--ink);
      cursor:pointer;
      box-shadow: 0 2px 0 rgba(17,24,39,.03);
    }
    button:hover{
      box-shadow: 0 10px 20px rgba(17,24,39,.06);
      transform: translateY(-1px);
    }

    textarea{
      width:100%;
      flex: 1 1 auto;
      min-height:0;
      resize: none;
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px 10px;
      font-family: var(--mono);
      font-size: 12.5px;
      line-height: 1.55;
      background: linear-gradient(180deg, #ffffff 0%, #fbfbff 100%);
      outline:none;
    }

    .note{
      color:var(--muted);
      font-size:11.5px;
      line-height:1.5;
    }
  
    /* --- Output + Visualizations --- */
    .outBody{
      display:flex;
      flex-direction:column;
      gap:10px;
      height:100%;
      min-height:0;
    }
    textarea[name="output"]{
      max-height: none;
    }

    .viz{
      flex: 1 1 auto;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap: 10px;
      position: relative;
    }

    /* Tabs */
    .tabs{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap:wrap;
    }
    .tabBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 12px;
      color: var(--ink);
      cursor:pointer;
      box-shadow: 0 2px 0 rgba(17,24,39,.03);
      user-select:none;
    }
    .tabBtn.is-active{
      background:#eef2ff;
      border-color:#c7d2fe;
      box-shadow: 0 10px 20px rgba(99,102,241,.10);
      font-weight: 700;
    }
    .tabNote{
      margin-left:auto;
      color: var(--muted);
      font-size: 11.5px;
      white-space:nowrap;
    }

    .miniBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      color: var(--ink);
      cursor:pointer;
      white-space:nowrap;
      box-shadow: 0 2px 0 rgba(17,24,39,.03);
      user-select:none;
    }
    .miniBtn.is-active{
      background:#f3f4f6;
      border-color:#d1d5db;
      font-weight: 700;
    }

    /* Overrides panel */
    .overridePanel{
      position:absolute;
      right: 10px;
      bottom: 10px;
      width: 330px;
      max-width: calc(100% - 20px);
      border:1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.94);
      box-shadow: 0 18px 46px rgba(17,24,39,.14);
      backdrop-filter: blur(6px);
      padding: 10px 10px 10px;
      display:none;
      flex-direction:column;
      gap: 10px;
      z-index: 5;
    }
    .overridePanel.is-on{ display:flex; }

    .ovHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .ovTitle{
      font-size: 12.5px;
      font-weight: 800;
      color: var(--ink);
      letter-spacing: .02em;
    }
    .ovClose{
      border:1px solid var(--line);
      background:#fff;
      width: 30px;
      height: 30px;
      border-radius: 10px;
      cursor:pointer;
      color: var(--muted);
      font-size: 16px;
      line-height: 1;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 2px 0 rgba(17,24,39,.03);
    }
    .ovHint{
      font-size: 11.5px;
      color: var(--muted);
      line-height: 1.35;
    }
    .ovBody{ min-height:0; }
    .ovSection{ display:block; }
    .ovSecTitle{ font-weight: 800; color: var(--ink); font-size: 12px; margin: 10px 0 8px; }

    .ovGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    .ovGrid5{ grid-template-columns: repeat(5, 1fr); }

    .ovField{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-width:0;
    }
    .ovLabel{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 6px;
      font-size: 11px;
      color: var(--muted);
      white-space:nowrap;
    }
    .ovAuto{
      font-variant-numeric: tabular-nums;
      opacity: .75;
    }
    .ovInput{
      width: 100%;
      border:1px solid var(--line);
      border-radius: 10px;
      padding: 6px 7px;
      font-size: 12px;
      color: var(--ink);
      background:#fff;
      outline:none;
      font-variant-numeric: tabular-nums;
    }
    .ovField.is-over .ovInput{
      border-color:#c7d2fe;
      box-shadow: 0 10px 20px rgba(99,102,241,.10);
    }

    .ovFoot{
      display:flex;
      justify-content:flex-end;
    }
    .ovBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 12px;
      padding: 7px 10px;
      font-size: 12px;
      cursor:pointer;
      color: var(--ink);
      box-shadow: 0 2px 0 rgba(17,24,39,.03);
    }
    
    .tabPanel{ display:none; flex: 1 1 auto; min-height:0; }
    .tabPanel.is-active{ display:flex; }

    .vizCard{
      flex: 1 1 auto;
      min-height:0;
      border:1px solid var(--line);
      border-radius: 14px;
      background: linear-gradient(180deg, #ffffff 0%, #fbfbff 100%);
      padding: 10px 10px 10px;
      box-shadow: 0 2px 0 rgba(17,24,39,.02);
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    
    /* Radar */
    .radarWrap{
      flex: 1 1 auto;
      min-height: 260px;
      display:flex;
      align-items:stretch;
      justify-content:stretch;
    }
    canvas#radar{
      width: 100%;
      height: 100%;
      max-height: 340px;
    }
    .miniLegend{
      color: var(--muted);
      font-size: 11.5px;
      line-height: 1.45;
      font-variant-numeric: tabular-nums;
      display:flex;
      flex-wrap:wrap;
      gap: 8px 12px;
    }
    .miniLegend .k{ color: var(--ink); font-weight: 650; }
    .miniLegend .pre{ opacity:.55; }
    .miniLegend .post{ opacity:.95; }

    /* Bipolar bars */
    #bipolar{
      display:flex;
      flex-direction:column;
      gap: 14px;
      font-size: 11.5px;
      color: var(--muted);
      min-height: 0;
    }
    .biRow{
      display:grid;
      grid-template-columns: .95fr 3.7fr .95fr;
      gap: 10px;
      align-items:center;
    }
    .biL{ text-align:right; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:12.5px; }
    .biR{ text-align:left; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:12.5px; }
    .biCenter{
      display:flex;
      align-items:center;
      gap: 0px;
      min-width:0;
    }
    .biTrack{
      position:relative;
      flex: 1 1 auto;
      height: 26px;
      border:1px solid var(--line);
      border-radius: 0;
      background:#fff;
      overflow:hidden;
    }
    .biMid{
      position:absolute;
      left:50%;
      top:0;
      bottom:0;
      width:1px;
      background: #d1d5db;
      opacity:.95;
    }
    .biFill{
      position:absolute;
      top:0;
      bottom:0;
      width:0%;
      border-radius: 0;
    }
    .biFill.pos{ left:50%; }
    .biFill.neg{ right:50%; }
    .biFill.raw{ background:#e5e7eb; opacity:.55; }
    .biFill.adj{ background:#c7d2fe; opacity:.95; }

    .biVal{
      font-variant-numeric: tabular-nums;
      color: var(--ink);
      font-weight: 750;
      white-space:nowrap;
      font-size: 12.5px;
    }
    .biVal .rawNum{
      color: var(--muted);
      font-weight: 650;
      margin-left: 8px;
      font-size: 12px;
      opacity: .85;
    }

    

    /* Larger bipolar panel */
    #tab-ment .vizCard{ padding-top: 12px; }
    
    /* Copy toast */
    .toast{
      position:absolute;
      right: calc(100% + 10px);
      top: 50%;
      transform: translateY(-50%) translateX(4px);
      display:inline-flex;
      align-items:center;
      padding: 6px 10px;
      border:1px solid var(--line);
      border-radius: 999px;
      background: rgba(255,255,255,.92);
      color: var(--muted);
      font-size: 11.5px;
      box-shadow: 0 6px 16px rgba(17,24,39,.06);
      opacity: 0;
      pointer-events:none;
      white-space:nowrap;
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.is-on{
      opacity: 1;
      transform: translateY(-50%) translateX(0px);
    }


    @media (max-height: 720px){
      .overridePanel{ width: 300px; }
      .ovGrid5{ grid-template-columns: repeat(3, 1fr); }
    }
  
    /* Output-side language selector */
    .miniLangWrap{
      display:inline-flex;
      align-items:center;
      position:relative;
    }
    .miniLang{
      appearance:none;
      -webkit-appearance:none;
      -moz-appearance:none;
      border:1px solid var(--line);
      background:#fff;
      border-radius: 999px;
      padding: 7px 30px 7px 10px;
      font-size: 12px;
      color: var(--ink);
      cursor:pointer;
      box-shadow: 0 2px 0 rgba(17,24,39,.03);
      line-height: 1;
      white-space:nowrap;
    }
    .miniLangWrap::after{
      content:"â–¾";
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      pointer-events:none;
      color:var(--muted);
      font-size: 12px;
      opacity:.8;
    }


    /* ---------- Main tabs (åŸºæœ¬è¨­å®š / ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«) ---------- */
    .topTabs{
      display:flex;
      gap:8px;
      align-items:center;
      padding: 0 2px;
    }
    .topTab{
      border:1px solid var(--line);
      background:#fff;
      color: var(--muted);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 700;
      cursor:pointer;
      box-shadow: 0 2px 0 rgba(17,24,39,.03);
      line-height: 1;
      user-select:none;
    }
    .topTab.is-active{
      color: var(--ink);
      border-color: rgba(99,102,241,.35);
      box-shadow: 0 10px 20px rgba(99,102,241,.10);
    }

    .mainPanel{
      flex: 1 1 auto;
      min-height:0;
      display:none;
    }
    .mainPanel.is-active{ display:flex; flex-direction:column; min-height:0; }

    .basicGrid{
      flex: 1 1 auto;
      min-height:0;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 12px;
      align-items:stretch;
    }

    .profileGrid{
      flex: 1 1 auto;
      min-height:0;
      display:grid;
      grid-template-columns: .95fr 1.05fr;
      gap: 12px;
      align-items:stretch;
    }

    /* ---------- Output mode tabs (ãƒãƒ£ãƒ¼ãƒˆ / ãƒ†ã‚­ã‚¹ãƒˆ) ---------- */
    .outModeTabs{
      display:flex;
      gap:6px;
      align-items:center;
      margin-left: 4px;
      flex: 0 0 auto;
      white-space: nowrap;
    }
    .outTab{
      border:1px solid var(--line);
      background:#fff;
      color: var(--muted);
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 11.5px;
      font-weight: 700;
      cursor:pointer;
      line-height: 1;
      user-select:none;
      white-space: nowrap;
    }
    .outTab.is-active{
      color: var(--ink);
      border-color: rgba(99,102,241,.35);
      box-shadow: 0 10px 20px rgba(99,102,241,.10);
    }

    .outBody{
      position:relative;
      flex:1 1 auto;
      min-height:0;
      display:flex;
      flex-direction:column;
    }
    .outPanel{
      flex: 1 1 auto;
      min-height:0;
      display:none;
      flex-direction: column;
    }
    .outPanel.is-active{ display:flex; min-height:0; }

    .vizStack{
      flex: 1 1 auto;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap: 10px;
      padding: 10px;
    }
    .radarCard{ flex: 1.2 1 auto; min-height: 0; }
    .bipolarCard{ flex: .8 1 auto; min-height: 0; }

    .outTextWrap{
      flex:1 1 auto;
      min-height:0;
      display:flex;
      padding: 10px;
    }
    .outTextWrap textarea{
      flex:1 1 auto;
      min-height:0;
      width:100%;
      height:100%;
      resize:none;
    }

    /* ---------- Profile widgets ---------- */
    .profileBody{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-height:0;
    }
    .profileTop{
      display:flex;
      gap: 12px;
      align-items:flex-start;
      min-height:0;
    }
    .avatarBox{
      width: 160px;
      flex: 0 0 160px;
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .avatar{
      width: 160px;
      height: 160px;
      border:1px solid var(--line);
      border-radius: 16px;
      background: linear-gradient(180deg, #ffffff 0%, #fbfbff 100%);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    .avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:none;
    }
    .avatar img.is-on{ display:block; }
    .avatarPh{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--muted);
      font-weight: 700;
      font-size: 12px;
      letter-spacing:.02em;
    }
    .avatarActions{
      display:flex;
      gap: 8px;
    }
    .ghostBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 11.5px;
      font-weight: 700;
      cursor:pointer;
      color: var(--ink);
      box-shadow: 0 2px 0 rgba(17,24,39,.03);
      line-height:1;
      user-select:none;
      white-space:nowrap;
    }
    .ghostBtn.muted{ color: var(--muted); }
    .profileNames{
      flex: 1 1 auto;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
    }
    .field input, .field textarea{
      border:1px solid var(--line);
      border-radius: 12px;
      padding: 10px 10px;
      font-size: 13px;
      color: var(--ink);
      background:#fff;
      outline:none;
    }
    .field textarea{
      min-height: 160px;
      resize:none;
    }
    .settingsGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(160px, 1fr));
      gap: 10px;
    }
    .settingsGrid .selectWrap select{
      font-size: 13px;
    }
    .exactAgeRow{
      display:flex;
      gap: 10px;
      align-items:flex-end;
    }
    .exactAgeRow .field{ flex: 1 1 auto; }
    .exactAgeRow input[type="number"]{ max-width: 160px; }
    .profileNote{
      color: var(--muted);
      font-size: 11px;
      line-height: 1.35;
    }

    @media (max-width: 980px){
      .basicGrid{ grid-template-columns: 1fr; }
      .profileGrid{ grid-template-columns: 1fr; }
      .avatarBox{ width: 140px; flex-basis: 140px; }
      .avatar{ width: 140px; height: 140px; }
    }


    .outTextFooter{
      flex: 0 0 auto;
      padding: 10px 12px;
      border-top: 1px solid var(--line);
      display:flex;
      justify-content:flex-end;
      align-items:center;
      gap: 8px;
    }
    .textActions{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      position: relative;
      flex: 0 0 auto;
      white-space: nowrap;
    }


    
    
    /* Bipolar scale labels aligned to bar track edges */
    .biScaleRow{
      display:grid;
      grid-template-columns: .95fr 3.7fr .95fr; /* keep in sync with .biRow */
      align-items:center;
      color: var(--muted);
      font-size: 12px;
      font-weight: 750;
      letter-spacing: .02em;
      padding: 2px 0 0;
      margin-bottom: -2px;
      user-select:none;
      font-variant-numeric: tabular-nums;
    }
    .biScaleTrack{
      position:relative;
      width:100%;
      height: 16px;
    }
    .biScaleTrack .biMin{ position:absolute; left:0; top:50%; transform:translateY(-50%); }
    .biScaleTrack .biZero{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); opacity:.9; }
    .biScaleTrack .biMax{ position:absolute; right:0; top:50%; transform:translateY(-50%); }

    /* Tighten radar frame whitespace */
    .vizCard.radarCard{ padding: 6px; }
    .vizCard.bipolarCard{ padding: 10px 10px 12px; }


    /* Stamina hearts (Charts tab header) */
    .staminaCard{
      display:grid;
      grid-template-columns: 1fr auto 1fr; /* keeps hearts centered even if range changes */
      align-items:center;
      gap: 10px;
      padding: 8px 10px;
    }
    .staminaCard .staminaLabel{
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .02em;
      color: var(--muted);
      white-space: nowrap;
      justify-self: start;
    }
    .staminaCard .staminaHearts{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 2px;
      justify-self: center;
    }
    .staminaCard .staminaHearts .h{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width: 0.95em; /* normalize glyph width (â™¥ vs â™¡) */
      font-size: 13px;
      line-height: 1;
    }
    .staminaCard .staminaHearts .h.full{ color: #6366f1; }
    .staminaCard .staminaHearts .h.empty{ color: rgba(17,24,39,.22); }
    .staminaCard.is-outlier .staminaHearts .h.full{ color: #a855f7; }
    .staminaCard .staminaRange{
      font-size: 12px;
      font-weight: 750;
      color: var(--muted);
      white-space: nowrap;
      font-variant-numeric: tabular-nums;
      justify-self: end;
    }
    .staminaCard .staminaRange .hpMax{ color: inherit; }
    .staminaCard.is-outlier .staminaRange .hpMax{ color: #a855f7; }


    /* Inline manual controls (seamless) */
    .cornerBtn{
      position:absolute;
      top: 10px;
      right: 10px;
      z-index: 6;
    }
    .vizCard.radarCard{ position: relative; }
    .vizCard.bipolarCard{ position: relative; }

    .radarWrap{
      position: relative;
      padding: 22px 14px 16px 14px;
      flex: 1 1 auto;
      min-height: 290px;
      padding: 10px 14px 16px 14px;
      display:flex;
      align-items:stretch;
      justify-content:stretch;
    }
    #radar{ width:100%; height:100%; display:block; }

    .radarOverlay{
      position:absolute;
      inset: 0;
      pointer-events:none;
      z-index: 5;
    }
    .statCtl{
      position:absolute;
      width: 110px;
      text-align:center;
      pointer-events:auto;
      user-select:none;
    }
    .statTop{
      display:flex;
      gap: 6px;
      justify-content:center;
      align-items:baseline;
      font-size: 12px;
      font-weight: 800;
      color: var(--muted);
      margin-bottom: 4px;
      white-space: nowrap;
    }

    .statSpin{
      width: 64px;
      height: 26px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #fff;
      text-align: center;
      font-weight: 800;
      font-variant-numeric: tabular-nums;
      box-shadow: 0 1px 0 rgba(17,24,39,.02);
    }
    .statSpin:focus{ outline: none; box-shadow: 0 0 0 4px rgba(99,102,241,.15); border-color: rgba(99,102,241,.6); }
    .statCtl.is-manual .statSpin{ border-color: rgba(99,102,241,.75); color: #6366f1; }
    .statCtl.is-manual .statTop{ color: #111827; }

    /* positions around radar */
    .pos-dex{ top: 2px; left: 50%; transform: translateX(-50%); }
    .pos-agi{ top: 52px; right: 6px; }
    .pos-int{ bottom: 52px; right: 6px; }
    .pos-str{ bottom: 6px; left: 50%; transform: translateX(-50%); }
    .pos-vit{ bottom: 52px; left: 6px; }
    .pos-will{ top: 52px; left: 6px; }

    .radarSum{
      position:absolute;
      left: 12px;
      bottom: 10px;
      z-index: 5;
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      background: rgba(255,255,255,.85);
      padding: 4px 8px;
      border: 1px solid rgba(17,24,39,.08);
      border-radius: 10px;
      box-shadow: 0 2px 0 rgba(17,24,39,.02);
      pointer-events:none;
      font-variant-numeric: tabular-nums;
    }

    /* Hide legacy manual override panel UI */
    #overridePanel{ display:none !important; }


    /* Bipolar sliders (seamless with bars) */
    .biTrackWrap{ display:flex; align-items:center; }
    .biSlider{
      -webkit-appearance:none;
      appearance:none;
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      background: transparent;
      margin:0;
      cursor:pointer;
    }
    .biSlider:focus{ outline:none; }
    .biSlider::-webkit-slider-runnable-track{ height: 26px; background: transparent; }
    .biSlider::-webkit-slider-thumb{
      -webkit-appearance:none;
      width: 18px;
      height: 28px;
      border-radius: 2px;
      background: rgba(99,102,241,.65);
      border: 1px solid rgba(99,102,241,.8);
      box-shadow: 0 3px 10px rgba(17,24,39,.10);
      cursor: grab;
    }
    .biSlider::-moz-range-track{ height:26px; background: transparent; border: none; }
    .biSlider::-moz-range-thumb{
      width: 18px;
      height: 28px;
      border-radius: 2px;
      background: rgba(99,102,241,.65);
      border: 1px solid rgba(99,102,241,.8);
      box-shadow: 0 3px 10px rgba(17,24,39,.10);
      cursor: grab;
    }


    /* Layout nudge: prevent overlaps */
    .vizCard.bipolarCard{ padding-top: 34px; }
    #bipolar{ margin-top: 8px; }
    /* keep reset button above without colliding */
    .vizCard.bipolarCard .cornerBtn{ top: 12px; }

</style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>ç›—è³Šã®çœ¼ ver 1.05b3 (Bilingual Output Edition)</h1>
        <p class="sub">ãƒšãƒ¼ã‚¸ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç„¡ã—ã€‚ç‰¹å¾´æ¬„ã®ã¿å†…éƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§åã‚ã¾ã™ã€‚</p>
      </div>
      <div class="badge">ğŸª¶ base: featherGuiz / Nyakazu_tobazu</div>
    </header>

    <form id="cwForm" action="#" method="post" onsubmit="return false;">
      <div class="topTabs" role="tablist" aria-label="Main tabs">
        <button type="button" class="topTab is-active" data-main="basic">åŸºæœ¬è¨­å®š</button>
        <button type="button" class="topTab" data-main="profile">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</button>
      </div>

      <div class="mainPanel is-active" id="main-basic" aria-label="Basic panel">
        <div class="basicGrid">
<!-- Left -->
      <section class="card">
        <div class="head">
          <h2>ç‰¹æ€§</h2>
</div>

        <div class="body">
          <div class="traitsHeader">
            <div class="tTitle">ç‰¹å¾´ï¼ˆ24é …ç›®ãƒ»3æŠï¼‰</div>
            <div class="traitsRight">
              <button type="button" id="resetTraitsBtn" class="miniBtn">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
          </div>

          <div class="traitsViewport">
            <div id="traitsGrid" class="traitsGrid" aria-label="Traits"></div>
          </div>
</div>
      </section>

      

      <!-- Right -->
      <section class="card">
        <div class="head">
<div class="outModeTabs" role="tablist" aria-label="Output mode">
            <button type="button" class="outTab is-active" data-out="charts">ãƒãƒ£ãƒ¼ãƒˆ</button>
            <button type="button" class="outTab" data-out="text">ãƒ†ã‚­ã‚¹ãƒˆ</button>
          </div>

          <div class="actions">
</div>
        </div>

        <div class="body">
          <div class="outBody">
            <div class="outPanel is-active" id="out-charts" aria-label="Charts">
              <div class="vizStack">
                
              <div class="vizCard staminaCard" id="staminaRow" aria-label="ä½“åŠ›ï¼ˆæœ€å°-æœ€å¤§ï¼‰">
                <div class="staminaLabel">ä½“åŠ›ï¼ˆæœ€å°-æœ€å¤§ï¼‰</div>
                <div class="staminaHearts" id="staminaHearts" aria-hidden="true"></div>
                <div class="staminaRange" id="staminaRange"></div>
              </div>
<div class="vizCard radarCard" id="radarCard">
                  <button type="button" class="miniBtn cornerBtn" id="resetPhysicalBtn">é©æ­£å€¤</button>
                  <div class="radarWrap">
                    <canvas id="radar"></canvas>

                    <div class="radarOverlay" id="radarOverlay" aria-label="èº«ä½“èƒ½åŠ› æ‰‹å‹•èª¿æ•´">
                      <div class="statCtl pos-dex">
                        <div class="statTop"><span class="statName">å™¨ç”¨åº¦</span></div>
                        <input class="statSpin" id="spinDex" data-idx="2" type="number" min="1" max="12" step="1" inputmode="numeric" aria-label="å™¨ç”¨åº¦">
                      </div>
                      <div class="statCtl pos-agi">
                        <div class="statTop"><span class="statName">æ•æ·åº¦</span></div>
                        <input class="statSpin" id="spinAgi" data-idx="3" type="number" min="1" max="12" step="1" inputmode="numeric" aria-label="æ•æ·åº¦">
                      </div>
                      <div class="statCtl pos-int">
                        <div class="statTop"><span class="statName">çŸ¥åŠ›</span></div>
                        <input class="statSpin" id="spinInt" data-idx="4" type="number" min="1" max="12" step="1" inputmode="numeric" aria-label="çŸ¥åŠ›">
                      </div>
                      <div class="statCtl pos-str">
                        <div class="statTop"><span class="statName">ç­‹åŠ›</span></div>
                        <input class="statSpin" id="spinStr" data-idx="5" type="number" min="1" max="12" step="1" inputmode="numeric" aria-label="ç­‹åŠ›">
                      </div>
                      <div class="statCtl pos-vit">
                        <div class="statTop"><span class="statName">ç”Ÿå‘½åŠ›</span></div>
                        <input class="statSpin" id="spinVit" data-idx="6" type="number" min="1" max="12" step="1" inputmode="numeric" aria-label="ç”Ÿå‘½åŠ›">
                      </div>
                      <div class="statCtl pos-will">
                        <div class="statTop"><span class="statName">ç²¾ç¥åŠ›</span></div>
                        <input class="statSpin" id="spinWill" data-idx="7" type="number" min="1" max="12" step="1" inputmode="numeric" aria-label="ç²¾ç¥åŠ›">
                      </div>
                    </div>

                    <div class="radarSum" id="radarSum" aria-label="åˆè¨ˆå€¤">åˆè¨ˆå€¤: -</div>
                  </div>
</div>
                <div class="vizCard bipolarCard">
                  <button type="button" class="miniBtn cornerBtn" id="resetMentalBtn">é©æ­£å€¤</button>
                  <div class="biScaleRow" aria-hidden="true"><div></div><div class="biScaleTrack"><span class="biMin">-4</span><span class="biZero">0</span><span class="biMax">+4</span></div><div></div></div>
                  <div id="bipolar"></div>
                </div>
              </div>
            </div>

            <div class="outPanel" id="out-text" aria-label="Text output">
              <div class="outTextWrap">
                <textarea name="output" wrap="hard" spellcheck="false" aria-label="Output"></textarea>
              </div>
              <div class="outTextFooter">
                <div class="textActions" aria-label="Text actions">
                  <span class="toast" id="copyToast" aria-live="polite" aria-atomic="true">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ</span>
                  <button type="button" class="miniBtn" id="copyBtn">ã‚³ãƒ”ãƒ¼</button>
                  <span class="miniLangWrap">
                    <select class="miniLang" name="out_lang" onchange="cw_analyze();" aria-label="Output language">
                      <option value="ja">æ—¥æœ¬èª</option>
                      <option value="en">English</option>
                    </select>
                  </span>
                </div>
              </div>
            </div>

            <div id="overridePanel" class="overridePanel" aria-hidden="true">
                <div class="ovHead">
                  <div class="ovTitle">æ‰‹å‹•</div>
                  <button type="button" class="ovClose" id="overrideCloseBtn" aria-label="Close">Ã—</button>
                </div>
                <div class="ovHint">ç©ºæ¬„ = è‡ªå‹•å€¤ï¼ˆå†…éƒ¨è¨ˆç®—ï¼‰</div>

                <div class="ovBody">
                  <div class="ovSection">
                    <div class="ovSecTitle">èº«ä½“èƒ½åŠ›</div>
                    <div class="ovGrid">
                      <label class="ovField" data-idx="2"><div class="ovLabel"><span>Dex</span><span class="ovAuto" data-idx="2"></span></div><input class="ovInput" type="number" inputmode="numeric" min="1" max="12" step="1" data-idx="2"></label>
                      <label class="ovField" data-idx="3"><div class="ovLabel"><span>Agi</span><span class="ovAuto" data-idx="3"></span></div><input class="ovInput" type="number" inputmode="numeric" min="1" max="12" step="1" data-idx="3"></label>
                      <label class="ovField" data-idx="4"><div class="ovLabel"><span>Int</span><span class="ovAuto" data-idx="4"></span></div><input class="ovInput" type="number" inputmode="numeric" min="1" max="12" step="1" data-idx="4"></label>
                      <label class="ovField" data-idx="5"><div class="ovLabel"><span>Str</span><span class="ovAuto" data-idx="5"></span></div><input class="ovInput" type="number" inputmode="numeric" min="1" max="12" step="1" data-idx="5"></label>
                      <label class="ovField" data-idx="6"><div class="ovLabel"><span>Vit</span><span class="ovAuto" data-idx="6"></span></div><input class="ovInput" type="number" inputmode="numeric" min="1" max="12" step="1" data-idx="6"></label>
                      <label class="ovField" data-idx="7"><div class="ovLabel"><span>Will</span><span class="ovAuto" data-idx="7"></span></div><input class="ovInput" type="number" inputmode="numeric" min="1" max="12" step="1" data-idx="7"></label>
                    </div>
                  </div>

                  <div class="ovSection">
                    <div class="ovSecTitle">ç²¾ç¥çš„èƒ½åŠ›</div>
                    <div class="ovGrid ovGrid5">
                      <label class="ovField" data-idx="8"><div class="ovLabel"><span>å¥½æˆ¦</span><span class="ovAuto" data-idx="8"></span></div><input class="ovInput" type="number" inputmode="numeric" min="-4" max="4" step="1" data-idx="8"></label>
                      <label class="ovField" data-idx="9"><div class="ovLabel"><span>ç¤¾äº¤</span><span class="ovAuto" data-idx="9"></span></div><input class="ovInput" type="number" inputmode="numeric" min="-4" max="4" step="1" data-idx="9"></label>
                      <label class="ovField" data-idx="10"><div class="ovLabel"><span>å‹‡çŒ›</span><span class="ovAuto" data-idx="10"></span></div><input class="ovInput" type="number" inputmode="numeric" min="-4" max="4" step="1" data-idx="10"></label>
                      <label class="ovField" data-idx="11"><div class="ovLabel"><span>æ…é‡</span><span class="ovAuto" data-idx="11"></span></div><input class="ovInput" type="number" inputmode="numeric" min="-4" max="4" step="1" data-idx="11"></label>
                      <label class="ovField" data-idx="12"><div class="ovLabel"><span>ç‹¡çŒ¾</span><span class="ovAuto" data-idx="12"></span></div><input class="ovInput" type="number" inputmode="numeric" min="-4" max="4" step="1" data-idx="12"></label>
                    </div>
                  </div>
                </div>

                <div class="ovFoot">
                  <button type="button" class="ovBtn" id="overrideResetBtn">ä¸Šæ›¸ãã‚’ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
              </div>
          </div>
        </div>
      </section>

        </div>
      </div>


      <div class="mainPanel" id="main-profile" aria-label="Profile panel">
        <div class="profileGrid">
          <section class="card">
            <div class="head">
              <h2>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
            </div>
            <div class="body profileBody">
              <div class="profileTop">
                <div class="avatarBox">
                  <div class="avatar">
                    <img id="profileImg" alt="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ">
                    <div class="avatarPh" id="profileImgPh">No Image</div>
                  </div>
                  <div class="avatarActions">
                    <button type="button" class="ghostBtn" id="profileImgPick">ç”»åƒ</button>
                    <button type="button" class="ghostBtn muted" id="profileImgClear">å‰Šé™¤</button>
                    <input type="file" id="profileImgInput" accept="image/*" hidden>
                    <input type="hidden" name="profile_image" id="profileImgData">
                  </div>
                </div>

                <div class="profileNames">
                  <label class="field">é€šç§°ï¼ˆè¡¨ç¤ºåï¼‰
                    <input type="text" name="profile_nick" placeholder="ä¾‹ï¼šãƒªãƒªã‚£">
                  </label>
                  <label class="field">ãƒ•ãƒ«ãƒãƒ¼ãƒ 
                    <input type="text" name="profile_full" placeholder="ä¾‹ï¼šLily von Example">
                  </label>
                  <div class="profileNote">â€»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«é …ç›®ã¯è¨ˆç®—ã«å½±éŸ¿ã—ã¾ã›ã‚“ï¼ˆå¹´é½¢åŒºåˆ†ã ã‘ã¯å¾“æ¥é€šã‚Šè¨ˆç®—ã«ä½¿ã„ã¾ã™ï¼‰ã€‚</div>
                </div>
              </div>
            </div>
          </section>

          <section class="card">
            <div class="head">
              <h2>è§£èª¬ / è¨­å®š</h2>
            </div>
            <div class="body profileBody">
              <label class="field">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è§£èª¬
                <textarea name="profile_desc" placeholder="ã“ã“ã«ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®è§£èª¬ã‚„è¨­å®šã‚’æ›¸ã‘ã¾ã™ã€‚"></textarea>
              </label>

              <div class="settingsGrid">
                <label class="select">
                  èƒ½åŠ›å‹
                  <span class="selectWrap"><select name="n_type" onchange="cw_analyze();">
                  <option>æ¨™æº–å‹</option><option>ä¸‡èƒ½å‹</option><option>å‹‡å°†å‹</option><option>è±ªå‚‘å‹</option><option>çŸ¥å°†å‹</option><option>ç­–å£«å‹</option>
                  <option>å‡¡åº¸å‹</option><option>è‹±æ˜å‹</option><option>ç„¡åŒå‹</option><option>å¤©æ‰å‹</option><option>è‹±é›„å‹</option><option>ç¥ä»™å‹</option>
                </select></span>
                </label>
                <label class="select">
                  æ€§åˆ¥
                  <span class="selectWrap"><select name="n_sex" onchange="cw_analyze();">
                  <option>ç”·ï¼â™‚</option><option>å¥³ï¼â™€</option>
                </select></span>
                </label>
                <label class="select">
                  å¹´é½¢åŒºåˆ†ï¼ˆè¨ˆç®—ã«ä½¿ç”¨ï¼‰
                  <span class="selectWrap"><select name="n_age" onchange="cw_analyze();">
                  <option>å­ä¾›</option><option selected>è‹¥è€…</option><option>å¤§äºº</option><option>è€äºº</option>
                </select></span>
                </label>
                <label class="field">å¹´é½¢ï¼ˆä»»æ„ï¼‰
                  <input type="number" name="profile_age_exact" inputmode="numeric" min="0" max="999" placeholder="ä¾‹ï¼š23">
                </label>
              </div>
            </div>
          </section>
        </div>
      </div>

</form>
  </div>

<script>
/* ---------- Traits UI (radios are the first 72 <input> in the form) ---------- */
(function buildTraits(){
  var labels = [
    'ç§€éº—','ãªã—','é†œæ‚ª',
    'é«˜è²´ã®å‡º','ãªã—','ä¸‹è³ã®å‡º',
    'éƒ½ä¼šè‚²ã¡','ãªã—','ç”°èˆè‚²ã¡',
    'è£•ç¦','ãªã—','è²§ä¹',
    'åšãä¿¡ä»°','ãªã—','ä¸å¿ƒå¾—è€…',
    'èª å®Ÿ','ãªã—','ä¸å®Ÿ',
    'å†·é™æ²ˆç€','ãªã—','çŒªçªçŒ›é€²',
    'è²ªæ¬²','ãªã—','ç„¡æ¬²',
    'çŒ®èº«çš„','ãªã—','åˆ©å·±çš„',
    'ç§©åºæ´¾','ãªã—','æ··æ²Œæ´¾',
    'é€²å–æ´¾','ãªã—','ä¿å®ˆæ´¾',
    'ç¥çµŒè³ª','ãªã—','éˆæ„Ÿ',
    'å¥½å¥‡å¿ƒæ—ºç››','ãªã—','ç„¡é “ç€',
    'éæ¿€','ãªã—','ç©å¥',
    'æ¥½è¦³çš„','ãªã—','æ‚²è¦³çš„',
    'å‹¤å‹‰','ãªã—','éŠã³äºº',
    'é™½æ°—','ãªã—','å†…æ°—',
    'æ´¾æ‰‹','ãªã—','åœ°å‘³',
    'é«˜æ…¢','ãªã—','è¬™è™š',
    'ä¸Šå“','ãªã—','ç²—é‡',
    'æ­¦éª¨','ãªã—','ç¹Šç´°',
    'ç¡¬æ´¾','ãªã—','è»Ÿæ´¾',
    'ãŠäººå¥½ã—','ãªã—','ã²ã­ãã‚Œè€…',
    'åèª‰ã“ãå‘½','ãªã—','æ„›ã«ç”Ÿãã‚‹'
  ];

  var grid = document.getElementById('traitsGrid');
  if(!grid) return;

  var html = [];
  for (var g = 0; g < 24; g++){
    var base = g*3;
    var left = labels[base], mid = labels[base+1], right = labels[base+2];

    html.push('<div class="traitRow">');
    html.push('  <div class="pillRow">');
    html.push('    <label class="pill"><input type="radio" name="c-'+g+'" onclick="cw_analyze();" />' + left + '</label>');
    html.push('    <label class="pill is-on"><input type="radio" name="c-'+g+'" onclick="cw_analyze();" checked />' + mid + '</label>');
    html.push('    <label class="pill"><input type="radio" name="c-'+g+'" onclick="cw_analyze();" />' + right + '</label>');
    html.push('  </div>');
    html.push('</div>');
  }
  grid.innerHTML = html.join('');

  // Visual active pill
  grid.addEventListener('click', function(e){
    var t = e.target;
    while (t && t !== grid && !(t.tagName && t.tagName.toLowerCase() === 'label')) t = t.parentNode;
    if (!t || t === grid) return;
    var input = t.querySelector('input[type="radio"]');
    if(!input) return;
    var name = input.name;
    var group = grid.querySelectorAll('input[name="'+name+'"]');
    for (var i=0;i<group.length;i++){
      var lab = group[i].closest('label');
      if(lab) lab.classList.remove('is-on');
    }
    t.classList.add('is-on');
  });
})();
</script>

<script>

/* ---------- Output sizing + Charts + Tabs ---------- */
function fmtSigned(n){
  var s = (n > 0 ? '+' : '') + (Math.round(n*10)/10);
  return s.replace(/\.0$/, '');
}
function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

function fitOutputArea(){
  // Only matters in Text mode (textarea fills available height)
  var panel = document.getElementById('out-text');
  var form = document.getElementById('cwForm');
  if(!panel || !form) return;
  if(!panel.classList.contains('is-active')) return;
  var ta = form['output'];
  if(!ta) return;

  // panel padding is handled by wrapper; keep textarea at 100%
  ta.style.height = '100%';
}

/* ---------- Radar chart (dual values) ---------- */
function poly(ctx, pts){
  ctx.beginPath();
  for (var i=0;i<pts.length;i++){
    var p = pts[i];
    if(i===0) ctx.moveTo(p[0], p[1]);
    else ctx.lineTo(p[0], p[1]);
  }
  ctx.closePath();
}
function drawRadarDual(raw, adj, labels, overrideMask){
  var c = document.getElementById('radar');
  if(!c) return;

  // visible sizing: use container width/height
  var wrap = c.parentElement;
  var w = wrap ? wrap.clientWidth : 0;
  var h = wrap ? wrap.clientHeight : 0;
  if(w < 10 || h < 10) return;

  // device pixel ratio
  var dpr = window.devicePixelRatio || 1;
  c.width = Math.floor(w * dpr);
  c.height = Math.floor(h * dpr);
  c.style.width = w + 'px';
  c.style.height = h + 'px';

  var ctx = c.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0);

  var cx = w/2, cy = h/2;
  var r = Math.min(w,h) * 0.387;
  var spokes = labels.length;

  // background
  ctx.clearRect(0,0,w,h);

  // grid rings (1..12)
  ctx.lineWidth = 1;
  ctx.strokeStyle = 'rgba(17,24,39,.08)';
  for (var k=1;k<=4;k++){
    var rr = r * (k/4);
    var pts = [];
    for (var i=0;i<spokes;i++){
      var a = (-Math.PI/2) + (i/spokes) * Math.PI*2;
      pts.push([cx + Math.cos(a)*rr, cy + Math.sin(a)*rr]);
    }
    poly(ctx, pts);
    ctx.stroke();
  }

  // spokes
  ctx.strokeStyle = 'rgba(17,24,39,.06)';
  for (var i=0;i<spokes;i++){
    var a = (-Math.PI/2) + (i/spokes) * Math.PI*2;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.lineTo(cx + Math.cos(a)*r, cy + Math.sin(a)*r);
    ctx.stroke();
  }

  // label text (integrated values)
  var baseCol = '#111827';
  var ovCol = '#6366f1';
  ctx.font = '12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto';
  ctx.textBaseline = 'middle';
  // labels are rendered as HTML controls (see .radarOverlay)
  function toPts(vals){
    var pts = [];
    for (var i=0;i<spokes;i++){
      var v = clamp(vals[i], 1, 12);
      var rr = r * ((v-1)/(12-1));
      var a = (-Math.PI/2) + (i/spokes) * Math.PI*2;
      pts.push([cx + Math.cos(a)*rr, cy + Math.sin(a)*rr]);
    }
    return pts;
  }

  // raw polygon (thin, light)
  var pr = toPts(raw);
  ctx.fillStyle = 'rgba(99,102,241,.10)';
  ctx.strokeStyle = 'rgba(99,102,241,.20)';
  ctx.lineWidth = 2;
  poly(ctx, pr);
  ctx.fill();
  ctx.stroke();

  // adj polygon (bold, darker)
  var pa = toPts(adj);
  ctx.fillStyle = 'rgba(17,24,39,.12)';
  ctx.strokeStyle = 'rgba(17,24,39,.40)';
  ctx.lineWidth = 2.5;
  poly(ctx, pa);
  ctx.fill();
  ctx.stroke();
}

function renderRadarLegend(raw, adj, labels){
  var el = document.getElementById('radarLegend');
  if(!el) return;
  var html = [];
  for (var i=0;i<labels.length;i++){
    var r = raw[i], a = adj[i];
    html.push('<span class="lgItem"><span class="lgK">'+labels[i]+'</span> <span class="rawNum">'+r+'</span><span class="adjNum">'+a+'</span></span>');
  }
  el.innerHTML = html.join('');
}

/* ---------- Bipolar bars (dual values) ---------- */
function renderBipolarDual(items){
  var host = document.getElementById('bipolar');
  if(!host) return;

  var man = window.__inlineManual || (window.__inlineManual = {});
  var ov = window.__inlineOverride || (window.__inlineOverride = {});

  host.innerHTML = '';

  items.forEach(function(it){
    var row = document.createElement('div');
    row.className = 'biRow';

    var l = document.createElement('div');
    l.className = 'biL';
    l.textContent = it.l;

    var r = document.createElement('div');
    r.className = 'biR';
    r.textContent = it.r;

    var trackWrap = document.createElement('div');
    trackWrap.className = 'biTrackWrap';

    var track = document.createElement('div');
    track.className = 'biTrack';

    var mid = document.createElement('div');
    mid.className = 'biMid';

    var rawFill = document.createElement('div');
    rawFill.className = 'biFill raw';
    var adjFill = document.createElement('div');
    adjFill.className = 'biFill adj';

    // Fill widths relative to [-4, +4]
    var raw = Number(it.raw || 0);
    var adj = Number(it.adj || 0);

    function setFill(fillEl, v){
      v = Math.max(-4, Math.min(4, v));
      if(v >= 0){
        fillEl.classList.remove('neg'); fillEl.classList.add('pos');
        fillEl.style.width = (v/4*50) + '%';
      }else{
        fillEl.classList.remove('pos'); fillEl.classList.add('neg');
        fillEl.style.width = (Math.abs(v)/4*50) + '%';
      }
    }
    setFill(rawFill, raw);
    setFill(adjFill, adj);

    track.appendChild(rawFill);
    track.appendChild(adjFill);
    track.appendChild(mid);

    // Slider overlay (controls adj)
    var slider = document.createElement('input');
    slider.type = 'range';
    slider.min = -4; slider.max = 4; slider.step = 1;
    slider.className = 'biSlider';
    slider.setAttribute('data-idx', String(it.idx));
    slider.value = String(adj);
    slider.setAttribute('aria-label', it.l + ' â†” ' + it.r);

    // Mark manual state on focus interaction
    slider.addEventListener('input', function(){
      var idx = parseInt(slider.getAttribute('data-idx') || '', 10);
      if(!isFinite(idx)) return;
      man[idx] = true;
      ov[idx] = parseInt(slider.value, 10);
      // live update fill for responsiveness
      setFill(adjFill, Number(slider.value));
      // also recalc dependent outputs
      cw_analyze();
    });

    track.appendChild(slider);
    trackWrap.appendChild(track);

    row.appendChild(l);
    row.appendChild(trackWrap);
    row.appendChild(r);

    host.appendChild(row);
  });
}

/* ---------- Output mode tabs (ãƒãƒ£ãƒ¼ãƒˆ / ãƒ†ã‚­ã‚¹ãƒˆ) ---------- */
function setOutputMode(mode){
  var btns = document.querySelectorAll('.outTab');
  for (var i=0;i<btns.length;i++){
    btns[i].classList.toggle('is-active', btns[i].getAttribute('data-out') === mode);
  }
  var charts = document.getElementById('out-charts');
  var text = document.getElementById('out-text');
  if(charts) charts.classList.toggle('is-active', mode === 'charts');
  if(text) text.classList.toggle('is-active', mode === 'text');

  // sizing + redraw
  setTimeout(function(){
    fitOutputArea();
    drawActiveViz();
  }, 0);
}
function initOutputTabs(){
  var btns = document.querySelectorAll('.outTab');
  for (var i=0;i<btns.length;i++){
    btns[i].addEventListener('click', function(e){
      setOutputMode(this.getAttribute('data-out'));
    });
  }
}

/* ---------- Main tabs (åŸºæœ¬è¨­å®š / ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«) ---------- */
function setMainTab(which){
  var btns = document.querySelectorAll('.topTab');
  for (var i=0;i<btns.length;i++){
    btns[i].classList.toggle('is-active', btns[i].getAttribute('data-main') === which);
  }
  var basic = document.getElementById('main-basic');
  var profile = document.getElementById('main-profile');
  if(basic) basic.classList.toggle('is-active', which === 'basic');
  if(profile) profile.classList.toggle('is-active', which === 'profile');

  setTimeout(function(){
    fitOutputArea();
    drawActiveViz();
  }, 0);
}
function initMainTabs(){
  var btns = document.querySelectorAll('.topTab');
  for (var i=0;i<btns.length;i++){
    btns[i].addEventListener('click', function(){
      setMainTab(this.getAttribute('data-main'));
    });
  }
}

/* ---------- Override panel ---------- */
function toggleOverridePanel(force){
  var panel = document.getElementById('overridePanel');
  var btn = document.getElementById('overrideBtn');
  if(!panel || !btn) return;

  var on = (typeof force === 'boolean') ? force : !panel.classList.contains('is-on');
  panel.classList.toggle('is-on', on);
  panel.setAttribute('aria-hidden', on ? 'false' : 'true');
  btn.setAttribute('aria-expanded', on ? 'true' : 'false');
  btn.classList.toggle('is-active', on);

  if(on){
    var first = panel.querySelector('.ovInput');
    if(first) first.focus();
  }
}
function resetOverrides(){
  var inputs = document.querySelectorAll('.ovInput');
  for (var i=0;i<inputs.length;i++){
    inputs[i].value = '';
  }
  if(typeof cw_analyze === 'function') cw_analyze();
}
function applyManualOverrides(autoActual, actual){
  // Seamless inline overrides (no separate panel)
  window.__overrideIdx = window.__overrideIdx || {};
  for (var k in window.__overrideIdx) { if(Object.prototype.hasOwnProperty.call(window.__overrideIdx,k)) delete window.__overrideIdx[k]; }

  var ov = window.__inlineOverride || (window.__inlineOverride = {});
  var man = window.__inlineManual || (window.__inlineManual = {});

  // Apply only the indices currently marked as manual
  for (var key in man){
    if(!Object.prototype.hasOwnProperty.call(man, key)) continue;
    if(!man[key]) continue;
    var idx = parseInt(key, 10);
    if(!isFinite(idx)) continue;
    var v = ov[idx];
    if(v === null || v === undefined) continue;
    var n = parseInt(v, 10);
    if(!isFinite(n)) continue;

    // Clamp per domain
    if(idx >= 2 && idx <= 7){
      n = Math.max(1, Math.min(12, n));
    }else if(idx >= 8 && idx <= 12){
      n = Math.max(-4, Math.min(4, n));
    }else{
      continue;
    }
    actual[idx] = n;
    window.__overrideIdx[idx] = true;
  }

  // Sync physical spinners (always exist in DOM)
  var spins = document.querySelectorAll('.statSpin');
  spins.forEach(function(inp){
    var idx = parseInt(inp.getAttribute('data-idx') || '', 10);
    if(!isFinite(idx)) return;
    if(man[idx]){
      // keep manual value
      var v = ov[idx];
      if(v === null || v === undefined || v === '') v = actual[idx];
      inp.value = v;
    }else{
      inp.value = autoActual[idx];
    }
  });
}

function renderStamina(minHp, maxHp){
  var row = document.getElementById('staminaRow');
  var hearts = document.getElementById('staminaHearts');
  var range = document.getElementById('staminaRange');
  if(!row || !hearts || !range) return;

  // Heart count is based on max stamina (10pt per heart), capped at 14.
  var filled = Math.max(0, Math.min(14, Math.floor((maxHp || 0) / 10)));
  var total = 14;

  var out = [];
  for(var i=0;i<total;i++){
    out.push('<span class="h ' + (i < filled ? 'full' : 'empty') + '">' + (i < filled ? 'â™¥' : 'â™¡') + '</span>');
  }
  hearts.innerHTML = out.join('');

  // Range in parentheses
  if(typeof minHp === 'number' && typeof maxHp === 'number'){
    range.innerHTML = 'ï¼ˆ' + minHp + '-' + '<span class="hpMax">' + maxHp + '</span>' + 'ï¼‰';
  }else{
    range.textContent = '';
  }

  // Outlier styling
  row.classList.toggle('is-outlier', (maxHp || 0) > 150);
}

function initOverrides(){
  var btn = document.getElementById('overrideBtn');
  var closeBtn = document.getElementById('overrideCloseBtn');
  var resetBtn = document.getElementById('overrideResetBtn');
  var panel = document.getElementById('overridePanel');

  if(btn) btn.addEventListener('click', function(){ toggleOverridePanel(); });
  if(closeBtn) closeBtn.addEventListener('click', function(){ toggleOverridePanel(false); });
  if(resetBtn) resetBtn.addEventListener('click', resetOverrides);

  if(panel){
    var inputs = panel.querySelectorAll('.ovInput');
    for (var i=0;i<inputs.length;i++){
      inputs[i].addEventListener('focus', function(e){
        var inp = e.target;
        var raw = (inp.value || '').trim();
        if(raw.length) return;

        var auto = inp.dataset.autoval || inp.placeholder || '';
        if(auto.length){
          inp.value = auto;
          inp.dataset.tempfill = '1';
          setTimeout(function(){ try{ inp.select(); }catch(_e){} }, 0);
        }
      });

      inputs[i].addEventListener('blur', function(e){
        var inp = e.target;
        if(inp.dataset.tempfill !== '1') return;

        var auto = inp.dataset.autoval || inp.placeholder || '';
        var raw = (inp.value || '').trim();

        if(auto.length && raw === String(auto)){
          inp.value = '';
          inp.dataset.tempfill = '';
          if(typeof cw_analyze === 'function') cw_analyze();
        }else{
          inp.dataset.tempfill = '';
        }
      });

      inputs[i].addEventListener('input', function(){
        if(typeof cw_analyze === 'function') cw_analyze();
      });
    }

    document.addEventListener('keydown', function(e){
      if(e.key === 'Escape' && panel.classList.contains('is-on')){
        toggleOverridePanel(false);
      }
    });
  }
}

/* ---------- Draw charts only when visible ---------- */
function drawActiveViz(){
  var charts = document.getElementById('out-charts');
  var basic = document.getElementById('main-basic');
  if(!charts || !basic) return;
  if(!charts.classList.contains('is-active')) return;
  if(!basic.classList.contains('is-active')) return;

  if(window.__lastRadarRaw && window.__lastRadarAdj){
    drawRadarDual(window.__lastRadarRaw, window.__lastRadarAdj, window.__lastRadarLabels || ['Dex','Agi','Int','Str','Vit','Will'], window.__lastRadarOverride || null);
  }
}

/* ---------- Profile image ---------- */
function initProfile(){
  var inp = document.getElementById('profileImgInput');
  var pick = document.getElementById('profileImgPick');
  var clear = document.getElementById('profileImgClear');
  var img = document.getElementById('profileImg');
  var ph = document.getElementById('profileImgPh');
  var hidden = document.getElementById('profileImgData');

  if(pick && inp){
    pick.addEventListener('click', function(){ inp.click(); });
  }
  if(clear){
    clear.addEventListener('click', function(){
      if(inp) inp.value = '';
      if(img){ img.src = ''; img.classList.remove('is-on'); }
      if(ph) ph.style.display = 'flex';
      if(hidden) hidden.value = '';
    });
  }
  if(inp && img){
    inp.addEventListener('change', function(){
      var file = inp.files && inp.files[0];
      if(!file) return;
      var fr = new FileReader();
      fr.onload = function(){
        img.src = String(fr.result || '');
        img.classList.add('is-on');
        if(ph) ph.style.display = 'none';
        if(hidden) hidden.value = img.src;
      };
      fr.readAsDataURL(file);
    });
  }
}

window.addEventListener('resize', function(){
  fitOutputArea();
  drawActiveViz();
});


function updateRadarOverlay(autoActual, actual){
  var man = window.__inlineManual || (window.__inlineManual = {});
  var ov = window.__inlineOverride || (window.__inlineOverride = {});

  var map = [
    {idx:2, spinId:'spinDex'},
    {idx:3, spinId:'spinAgi'},
    {idx:4, spinId:'spinInt'},
    {idx:5, spinId:'spinStr'},
    {idx:6, spinId:'spinVit'},
    {idx:7, spinId:'spinWill'}
  ];

  map.forEach(function(it){
    var sp = document.getElementById(it.spinId);
    if(!sp) return;

    // Keep override value sensible even if manual flag is off
    if(!man[it.idx]){
      ov[it.idx] = autoActual[it.idx];
    }
    var val = man[it.idx] ? ov[it.idx] : autoActual[it.idx];

    sp.value = String(val);

    var ctl = sp.closest('.statCtl');
    if(ctl) ctl.classList.toggle('is-manual', !!man[it.idx]);
    sp.classList.toggle('is-manual', !!man[it.idx]);
  });
}

function initInlineManual(){
  window.__inlineManual = window.__inlineManual || {};
  window.__inlineOverride = window.__inlineOverride || {};

  // Physical spinners
  var spins = document.querySelectorAll('.statSpin');
  spins.forEach(function(inp){
    var idx = parseInt(inp.getAttribute('data-idx') || '', 10);
    if(!isFinite(idx)) return;

    // Avoid browser restoring stale values
    inp.value = inp.value || '';

    function handleSpin(){
      var v = parseInt(inp.value, 10);
      if(!isFinite(v)) return;
      window.__inlineManual[idx] = true;
      window.__inlineOverride[idx] = v;
      cw_analyze();
    }
    inp.addEventListener('input', handleSpin);
    inp.addEventListener('change', handleSpin);
  });

  // Reset buttons
  var btnP = document.getElementById('resetPhysicalBtn');
  if(btnP){
    btnP.addEventListener('click', function(){
      for(var i=2;i<=7;i++){
        delete window.__inlineManual[i];
        delete window.__inlineOverride[i];
      }
      cw_analyze();
    });
  }
  var btnM = document.getElementById('resetMentalBtn');
  if(btnM){
    btnM.addEventListener('click', function(){
      for(var i=8;i<=12;i++){
        delete window.__inlineManual[i];
        delete window.__inlineOverride[i];
      }
      cw_analyze();
    });
  }
}

document.addEventListener('DOMContentLoaded', function(){
  initMainTabs();
  initOutputTabs();
  initProfile();
  // defaults
  setMainTab('basic');
  setOutputMode('charts');
  fitOutputArea();
  drawActiveViz();
  initInlineManual();
});


/* ---------- Core analyzer (calculation unchanged; output bilingual) ---------- */
var cw_analyze = function (f, mod, index, nat) {
  var el = Array.apply(undefined, f.getElementsByTagName('input')), mx = Math.max, mi = Math.min;

  return function () {
    var
      status = ['', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      actual = status.slice(),
      l, i, j, radio = [], total = 0, a_total = 0;

    l = -3; while ((l += 3) < 72)
      radio[l / 3] = el[l].checked ? 1 : el[l + 1].checked ? 0 : 2;

    l = -1; while (++l < 27) {
      if (3 > l)
        i = index[l] + f[nat[l]].selectedIndex;
      else
        i = radio[l - 3] === 0 ? -1 : 18 + ((l - 3) * 2) + (radio[l - 3] === 1 ? 0 : 1);

      if (i !== -1) {
        status[0] += mod[i][0] + ' ';
        j = 0; while (++j < 13) if (mod[i][j]) status[j] += mod[i][j];
      }
    }

    actual[1] = status[1];
    l = 1; while (++l < 8)
      actual[l] = mx(1, mi(12, status[l])),
      total += status[l],
      a_total += actual[l];
    l = 7; while (++l < 13) actual[l] = mx(-4, mi(4, status[l] / 2 | 0));

    var lang = f['out_lang'] ? f['out_lang'].value : 'ja';
    var traitsJp = status[0].trim();
    var traitsList = traitsJp ? traitsJp.split(' ') : [];
    var sign = function(n){ return (n > 0 ? '+' : '') + n; };

    // --- Manual overrides (display only; calculation stays unchanged) ---
    var autoActual = actual.slice();
    applyManualOverrides(autoActual, actual);

    // Recompute adjusted total after overrides
    a_total = 0;
    var kk = 1;
    while(++kk < 8) a_total += actual[kk];

    // Stamina (HP) range for chart header
    var hpMin = (((actual[6] / 2 + 4) * 2 + (actual[7] / 2)) | 0);
    var hpMax = (((actual[6] / 2 + 4) * (actual[1] + 1) + (actual[7] / 2)) | 0);
    renderStamina(hpMin, hpMax);


    var traitEnMap = {
      'ç§€éº—':'Good-looking', 'é†œæ‚ª':'Ugly',
      'é«˜è²´ã®å‡º':'Noble Birth', 'ä¸‹è³ã®å‡º':'Humble Origin',
      'éƒ½ä¼šè‚²ã¡':'City Raised', 'ç”°èˆè‚²ã¡':'Country Raised',
      'è£•ç¦':'Wealthy', 'è²§ä¹':'Poor',
      'åšãä¿¡ä»°':'Devout', 'ä¸å¿ƒå¾—è€…':'Irreligious', 'ä¸ä¿¡å¾—è€…':'Irreligious',
      'èª å®Ÿ':'Sincere', 'ä¸å®Ÿ':'Insincere',
      'å†·é™æ²ˆç€':'Calm and Collected', 'çŒªçªçŒ›é€²':'Rash',
      'è²ªæ¬²':'Greedy', 'ç„¡æ¬²':'Content',
      'çŒ®èº«çš„':'Self-sacrificing', 'åˆ©å·±çš„':'Selfish',
      'ç§©åºæ´¾':'Lawful', 'æ··æ²Œæ´¾':'Chaotic',
      'é€²å–æ´¾':'Progressive', 'ä¿å®ˆæ´¾':'Conservative',
      'ç¥çµŒè³ª':'Neurotic', 'éˆæ„Ÿ':'Insensitive',
      'å¥½å¥‡å¿ƒæ—ºç››':'Curious', 'ç„¡é “ç€':'Indifferent',
      'éæ¿€':'Radical', 'ç©å¥':'Moderate',
      'æ¥½è¦³çš„':'Optimistic', 'æ‚²è¦³çš„':'Pessimistic',
      'å‹¤å‹‰':'Diligent', 'éŠã³äºº':'Pleasure-seeker',
      'é™½æ°—':'Cheerful', 'å†…æ°—':'Shy',
      'æ´¾æ‰‹':'Flashy', 'åœ°å‘³':'Plain',
      'é«˜æ…¢':'Arrogant', 'è¬™è™š':'Humble',
      'ä¸Šå“':'Refined', 'ç²—é‡':'Coarse',
      'æ­¦éª¨':'Blunt', 'ç¹Šç´°':'Sensitive',
      'ç¡¬æ´¾':'Earnest', 'è»Ÿæ´¾':'Flirtatious',
      'ãŠäººå¥½ã—':'Good-natured', 'ã²ã­ãã‚Œè€…':'Cynical',
      'åèª‰ã“ãå‘½':'Lives for Honor', 'æ„›ã«ç”Ÿãã‚‹':'Lives for Love'
    };

    if (lang === 'en') {
      var out = '';
      out += '- Stats:\n';
      out += '    Dexterity: ' + actual[2] + '\n';
      out += '    Agility: ' + actual[3] + '\n';
      out += '    Intelligence: ' + actual[4] + '\n';
      out += '    Strength: ' + actual[5] + '\n';
      out += '    Vitality: ' + actual[6] + '\n';
      out += '    Willpower: ' + actual[7] + '\n\n';

      out += '- Temperament:\n';
      out += '    Peaceful(-)â†”Aggressive(+): ' + sign(actual[8]) + '\n';
      out += '    Introverted(-)â†”Extroverted(+): ' + sign(actual[9]) + '\n';
      out += '    Cowardly(-)â†”Brave(+): ' + sign(actual[10]) + '\n';
      out += '    Bold(-)â†”Cautious(+): ' + sign(actual[11]) + '\n';
      out += '    Honest(-)â†”Cunning(+): ' + sign(actual[12]) + '\n\n';

      out += '- Personality traits:\n';
      if (traitsList.length) {
        var traitsEnList = traitsList.map(function(jp){ return traitEnMap[jp] || jp; });
        out += '    ' + traitsEnList.join(' | ') + '\n';
      } else {
        out += '    \n';
      }
      f['output'].value = out;

    } else {
      f['output'].value =
        ' ä½“åŠ› / ãƒ¬ãƒ™ãƒ«ä¸Šé™ï¼š' + ((actual[6] / 2 + 4) * 2 + actual[7] / 2 | 0) + 'ï½' + ((actual[6] / 2 + 4) * (actual[1] + 1) + actual[7] / 2 | 0) + ' pt / L' + actual[1] + '\n' +
        'ã€€ã€€ã€€ã€€ã€€ã€€å™¨ç”¨åº¦ï¼š' + actual[2] + ' (' + status[2] + ') pt\n' +
        'ã€€ã€€ã€€ã€€ã€€ã€€æ•æ·åº¦ï¼š' + actual[3] + ' (' + status[3] + ') pt\n' +
        'ã€€ã€€ã€€ã€€ã€€ã€€çŸ¥ã€€åŠ›ï¼š' + actual[4] + ' (' + status[4] + ') pt\n' +
        'ã€€ã€€ã€€ã€€ã€€ã€€ç­‹ã€€åŠ›ï¼š' + actual[5] + ' (' + status[5] + ') pt\n' +
        'ã€€ã€€ã€€ã€€ã€€ã€€ç”Ÿå‘½åŠ›ï¼š' + actual[6] + ' (' + status[6] + ') pt\n' +
        'ã€€ã€€ã€€ã€€ã€€ã€€ç²¾ç¥åŠ›ï¼š' + actual[7] + ' (' + status[7] + ') pt\n' +
        'ã€€ã€€ã€€ã€€èƒ½åŠ›å€¤åˆè¨ˆï¼š' + a_total + ' (' + total + ') pt\n' +
        'ã€€ã€€ã€€ã€€ã€€ã€€å¥½æˆ¦æ€§ï¼š' + actual[8] + ' (' + (status[8] / 2) + ')\n' +
        'ã€€ã€€ã€€ã€€ã€€ã€€ç¤¾äº¤æ€§ï¼š' + actual[9] + ' (' + (status[9] / 2) + ')\n' +
        'ã€€ã€€ã€€ã€€ã€€ã€€å‹‡çŒ›æ€§ï¼š' + actual[10] + ' (' + (status[10] / 2) + ')\n' +
        'ã€€ã€€ã€€ã€€ã€€ã€€æ…é‡æ€§ï¼š' + actual[11] + ' (' + (status[11] / 2) + ')\n' +
        'ã€€ã€€ã€€ã€€ã€€ã€€ç‹¡çŒ¾æ€§ï¼š' + actual[12] + ' (' + (status[12] / 2) + ')\n' +
        'ã€€ å›é¿åŠ› / æŠµæŠ—åŠ›ï¼š' + (actual[3] + actual[11]) + ' / ' + (actual[7] + actual[10]) + '\n' +
        'ã€€ã€€ã€€ã€€ã€€è¡Œå‹•é †ä½ï¼š' + (actual[3] - actual[11]) + '\n' +
        'æ··ä¹±ã‚«ãƒ¼ãƒ‰ã®é©æ€§å€¤ï¼š' + (actual[4] - actual[12]) + '\n' +
        'ã€€ã€€ã€€ã€€è‡ªç„¶æ²»ç™’åŠ›ï¼š' + (actual[6] + actual[8]) + '\n' +
        'ã€€ã€€ã€€é¸æŠã‚¯ãƒ¼ãƒãƒ³ï¼š' + traitsJp;
    }

    // --- Charts update (visual only; calculation untouched) ---
    // Physical radar: baseline (autoActual) vs current (actual)
    var radarRaw = [autoActual[2], autoActual[3], autoActual[4], autoActual[5], autoActual[6], autoActual[7]];
    var radarAdj = [actual[2], actual[3], actual[4], actual[5], actual[6], actual[7]];
    var radarLabs = ['å™¨ç”¨åº¦','æ•æ·åº¦','çŸ¥åŠ›','ç­‹åŠ›','ç”Ÿå‘½åŠ›','ç²¾ç¥åŠ›'];
    window.__lastRadarRaw = radarRaw;
    window.__lastRadarAdj = radarAdj;
    window.__lastRadarLabels = radarLabs;
    // Update inline labels + spinners + sum inside radar card
    updateRadarOverlay(autoActual, actual);
    var sumEl = document.getElementById('radarSum');
    if(sumEl) sumEl.textContent = 'åˆè¨ˆå€¤: ' + a_total;

    // per-axis override flags (Dex..Will) for label coloring
    window.__lastRadarOverride = [
      !!(window.__overrideIdx && window.__overrideIdx[2]),
      !!(window.__overrideIdx && window.__overrideIdx[3]),
      !!(window.__overrideIdx && window.__overrideIdx[4]),
      !!(window.__overrideIdx && window.__overrideIdx[5]),
      !!(window.__overrideIdx && window.__overrideIdx[6]),
      !!(window.__overrideIdx && window.__overrideIdx[7])
    ];

    // Temperament bipolar: baseline (autoActual) vs current (actual)
    renderBipolarDual([
      { idx: 8,  l:'å¹³å’Œæ€§', r:'å¥½æˆ¦æ€§', raw: autoActual[8],  adj: actual[8]  },
      { idx: 9,  l:'å†…å‘æ€§', r:'å¤–å‘æ€§', raw: autoActual[9],  adj: actual[9]  },
      { idx: 10, l:'è‡†ç—…æ€§', r:'å‹‡æ•¢æ€§', raw: autoActual[10], adj: actual[10] },
      { idx: 11, l:'å¤§èƒ†æ€§', r:'æ…é‡æ€§', raw: autoActual[11], adj: actual[11] },
      { idx: 12, l:'æ­£ç›´æ€§', r:'ç‹¡çŒ¾æ€§', raw: autoActual[12], adj: actual[12] }
    ]);

    // Fit textarea height to content (leave room for viz)
    fitOutputArea();
    // Draw only the active panel (prevents hidden-canvas 0px issue)
    setTimeout(drawActiveViz, 0);

  };
}(document.getElementById('cwForm'), [
  ['æ¨™æº–å‹',    10, 6, 6, 6, 6, 6, 7,-1, 0, 0, 1, 0],
  ['ä¸‡èƒ½å‹',    10, 7, 7, 6, 6, 6, 5, 0, 1, 0, 0, 0],
  ['å‹‡å°†å‹',    10, 5, 6, 5, 8, 6, 6, 0, 0, 2, 0, 0],
  ['è±ªå‚‘å‹',    10, 4, 5, 4, 9, 7, 5, 1, 0, 1,-1, 0],
  ['çŸ¥å°†å‹',    10, 6, 6, 8, 5, 5, 6, 0, 0, 0, 1, 0],
  ['ç­–å£«å‹',    10, 6, 5, 9, 4, 4, 6, 0, 0, 0, 1, 1],
  ['å‡¡åº¸å‹',    12, 4, 4, 4, 4, 4, 4, 0, 0, 1, 1, 0],
  ['è‹±æ˜å‹',    10, 7, 7, 7, 7, 7, 7, 0, 1, 0, 1, 0],
  ['ç„¡åŒå‹',    10, 6, 7, 6, 9, 8, 6, 1, 0, 1, 0, 0],
  ['å¤©æ‰å‹',    10, 7, 6, 9, 6, 6, 8, 0, 0, 0, 1, 1],
  ['è‹±é›„å‹',    12, 7, 7, 8, 8, 7, 8, 0, 1, 1, 0,-1],
  ['ç¥ä»™å‹',    15, 8, 8, 8, 8, 8, 8, 0, 0, 0, 0, 0],
  ['ç”·ï¼â™‚',     0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0],
  ['å¥³ï¼â™€',     0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0],
  ['å­ä¾›',       0, 1, 1, 0,-1,-1, 0, 0, 1, 0,-1, 0],
  ['è‹¥è€…',       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  ['å¤§äºº',       0, 0, 0, 0, 0,-1, 0,-1, 0, 0, 1, 0],
  ['è€äºº',       0,-1,-1, 1,-1,-1, 1,-1, 0,-1, 1, 1],
  ['ç§€éº—',       0, 0, 0, 0, 0,-1, 0, 0, 1, 0, 0, 0],
  ['é†œæ‚ª',       0, 0, 0, 0, 0, 1, 0, 0,-1, 0, 0, 0],
  ['é«˜è²´ã®å‡º',   0, 0, 0, 0, 0, 0, 0,-1, 0, 1, 0, 0],
  ['ä¸‹è³ã®å‡º',   0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-1, 1],
  ['éƒ½ä¼šè‚²ã¡',   0, 0, 0, 1, 0,-1, 0, 0, 1, 0, 0, 1],
  ['ç”°èˆè‚²ã¡',   0, 0,-1, 0, 0, 1, 0, 0, 0, 0, 0,-1],
  ['è£•ç¦',       0, 0, 0, 0, 0, 0,-1,-1, 0, 0, 0,-1],
  ['è²§ä¹',       0, 0, 0, 0, 0, 0, 1, 1, 0,-1, 0, 0],
  ['åšãä¿¡ä»°',   0, 0, 0,-1, 0, 0, 1, 0, 0, 1, 0,-1],
  ['ä¸ä¿¡å¾—è€…',   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1],
  ['èª å®Ÿ',       0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0,-1],
  ['ä¸å®Ÿ',       0, 0, 0, 0, 0, 0, 0, 0, 0,-1, 0, 1],
  ['å†·é™æ²ˆç€',   0, 0,-1, 1, 0, 0, 0, 0, 0, 0, 1, 1],
  ['çŒªçªçŒ›é€²',   0, 0, 1, 0, 0, 0,-1, 0, 0, 0,-1, 0],
  ['è²ªæ¬²',       0, 0, 0, 0, 0, 1,-1, 1, 0,-1,-1, 0],
  ['ç„¡æ¬²',       0, 0, 0, 0, 0, 0, 0,-1, 0, 0, 0, 0],
  ['çŒ®èº«çš„',     0, 0, 0, 0, 0,-1, 1,-1, 0, 0, 0, 0],
  ['åˆ©å·±çš„',     0,-1, 1, 0, 0, 0, 0, 1,-1, 0, 0, 1],
  ['ç§©åºæ´¾',     0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0,-1],
  ['æ··æ²Œæ´¾',     0, 0, 0, 0, 1, 0,-1, 1, 0, 0, 0, 1],
  ['é€²å–æ´¾',     0, 0, 1, 0, 0,-1, 0, 0, 0, 1,-1, 0],
  ['ä¿å®ˆæ´¾',     0, 0, 0, 0,-1, 0, 1,-1, 0, 0, 1, 0],
  ['ç¥çµŒè³ª',     0, 0, 1, 0,-1, 0, 0, 0,-1, 0, 1, 0],
  ['éˆæ„Ÿ',       0, 0, 0,-1, 0, 1, 0, 0, 0, 0, 0, 0],
  ['å¥½å¥‡å¿ƒæ—ºç››', 0, 1, 0, 0, 0,-1, 0, 0, 0, 0, 0, 0],
  ['ç„¡é “ç€',     0, 0,-1, 0, 0, 0, 1, 0,-1, 0, 0, 0],
  ['éæ¿€',       0, 0, 0, 0, 1,-1, 0, 1, 0, 0,-1, 0],
  ['ç©å¥',       0, 0, 0, 0, 0, 0, 0,-1, 0, 0, 1, 0],
  ['æ¥½è¦³çš„',     0, 1,-1, 0, 0, 0, 0, 0, 0, 1,-1, 0],
  ['æ‚²è¦³çš„',     0, 0, 0, 1, 0, 0,-1, 0, 0,-1, 1, 0],
  ['å‹¤å‹‰',       0,-1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0],
  ['éŠã³äºº',     0, 1, 0,-1, 0, 0, 0, 0, 1, 0, 0, 1],
  ['é™½æ°—',       0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0],
  ['å†…æ°—',       0, 0, 0, 0, 0, 0, 0, 0, 0,-1, 0, 0],
  ['æ´¾æ‰‹',       0, 0, 1,-1, 0, 0, 0, 0, 1, 0,-1, 0],
  ['åœ°å‘³',       0, 0, 0, 0,-1, 1, 0, 0, 0,-1, 0, 0],
  ['é«˜æ…¢',       0,-1, 0, 0, 0, 0, 1, 1,-1, 0, 0, 0],
  ['è¬™è™š',       0,-1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0],
  ['ä¸Šå“',       0, 0, 0, 1,-1, 0, 0,-1, 1, 0, 0, 0],
  ['ç²—é‡',       0, 0, 0,-1, 1, 0, 0, 1,-1, 0, 0, 0],
  ['æ­¦éª¨',       0,-1, 0, 0, 1, 0, 0, 0,-1, 1, 0, 0],
  ['ç¹Šç´°',       0, 1, 0, 0,-1, 0, 0, 0, 0,-1, 1, 0],
  ['ç¡¬æ´¾',       0, 0,-1, 0, 1, 0, 0, 0, 0, 1, 0,-1],
  ['è»Ÿæ´¾',       0, 1, 0, 0, 0, 0,-1, 0, 1,-1, 0, 0],
  ['ãŠäººå¥½ã—',   0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0,-1],
  ['ã²ã­ãã‚Œè€…', 0, 0, 0, 0, 0, 0, 0, 0,-1, 0, 0, 0],
  ['åèª‰ã“ãå‘½', 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,-1,-1],
  ['æ„›ã«ç”Ÿãã‚‹', 0, 0, 0, 0, 0, 0, 0,-1, 0, 0, 0, 0]
],
[0, 12, 14], ['n_type', 'n_sex', 'n_age']);

// Initial render
cw_analyze();

// Copy button
function flashCopyToast(){
  var t = document.getElementById('copyToast');
  if(!t) return;
  t.classList.add('is-on');
  clearTimeout(window.__copyToastTimer);
  window.__copyToastTimer = setTimeout(function(){
    t.classList.remove('is-on');
  }, 1400);
}

document.getElementById('copyBtn').addEventListener('click', async function(){
  var form = document.getElementById('cwForm');
  if(!form) return;
  var ta = form['output'];
  if(!ta) return;

  var text = ta.value || '';

  // Prefer modern Clipboard API (no selection). Works in secure contexts (https/localhost).
  try{
    if(navigator.clipboard && window.isSecureContext){
      await navigator.clipboard.writeText(text);
      flashCopyToast();
      return;
    }
  }catch(e){ /* fall through */ }

  // Fallback: execCommand requires selection. We'll copy, then immediately clear selection.
  var prev = document.activeElement;
  try{
    ta.focus();
    ta.select();
    var ok = document.execCommand('copy');
    // collapse selection and remove focus so the highlight disappears
    ta.setSelectionRange(ta.value.length, ta.value.length);
    ta.blur();
    if(prev && prev.focus) prev.focus();
    // clear any remaining selection in the page
    if(window.getSelection) window.getSelection().removeAllRanges();
    if(ok) flashCopyToast();
  }catch(e){
    // do nothing
  }
});


// Traits reset (set all 24 groups to "ãªã—")
function resetTraitsSelection(){
  for (var g=0; g<24; g++){
    var inputs = document.querySelectorAll('input[name="c-'+g+'"]');
    if(!inputs || inputs.length < 2) continue;

    // 0:left, 1:none, 2:right
    inputs[1].checked = true;

    // update pill highlight
    for (var i=0;i<inputs.length;i++){
      var lab = inputs[i].closest('label');
      if(lab) lab.classList.remove('is-on');
    }
    var midLab = inputs[1].closest('label');
    if(midLab) midLab.classList.add('is-on');
  }
  if (typeof cw_analyze === 'function') cw_analyze();
}

document.addEventListener('DOMContentLoaded', function(){
  var btn = document.getElementById('resetTraitsBtn');
  if(btn){
    btn.addEventListener('click', resetTraitsSelection);
  }
});


</script>
</body>
</html>
